apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  creationTimestamp: null
  name: override-image-tag-in-ops-repo
  namespace: cicd
spec:
  params:
  - name: OPS_GIT_REPO
    type: string
  - name: DESCRIPTION
    type: string
  - name: IMAGE
    type: string
  - name: BUILDER_IMAGE
    default: >-
        registry.redhat.io/rhel8/buildah@sha256:6a68ece207bc5fd8db2dd5cc2d0b53136236fb5178eb5b71eebe5d07a3c33d13
    description: The location of the buildah builder image.
    type: string
  
  steps:
  - image: $(params.BUILDER_IMAGE)
    name: update-ops-repo-with-imagetag
    resources: {}
    script: >
      #!/bin/sh

      git clone $(params.OPS_GIT_REPO)

      # set image for dev deployment

      cd python-gitops/environments/dev/apps/app-python-devfile/services/base/config
      
      kustomize edit set image $(params.IMAGE) 

      # set image for stage deployment 

      cd - 
      
      cd python-gitops/environments/stage/apps/app-python-devfile/services/base/config
      
      kustomize edit set image $(params.IMAGE)

      # Push back to git

      git add . 
      
      git commit -m "$(params.DESCRIPTION)"
      
      git push -u origin main
       